const ilceMahalle = {
    "Adalar": [
        "Büyükada - Maden", "Büyükada - Nizam", "Kınalıada", "Burgazada", "Heybeliada"],
    "Arnavutköy": [
        "Anadolu", "Adnan Menderes", "Arnavutköy Merkez", "Atatürk", "Baklalı", "Balaban",
        "Boğazköy İstiklal", "Bolluca", "Boyalık", "Çilingir", "Deliklikaya", "Dursunköy",
        "Durusu", "Fatih", "Hacımaşlı", "Hadımköy", "Haraççı", "Hastane", "Hicret", "İmrahor",
        "İslambey", "Karaburun", "Karlıbayır", "Mareşal Fevzi Çakmak", "Mavigöl",
        "Mehmet Akif Ersoy", "Mustafa Kemal Paşa", "Nenehatun", "Ömerli", "Sazlıbosna",
        "Taşoluk", "Tayakadın", "Terkos", "Yassıören", "Yavuz Selim", "Yeniköy",
        "Yeşilbayır", "Yunus Emre"], 
    "Ataşehir": [
        "Aşık Veysel", "Atatürk", "Barbaros", "Esatpaşa", "Ferhatpaşa", "Fetih", "İçerenköy", "İnönü",
        "Kayışdağı", "Küçükbakkalköy", "Mevlana", "Mimarsinan", "Mustafa Kemal", "Örnek", "Yeniçamlıca",
        "Yenisahra", "Yenişehir"
    ],
    "Avcılar": [
        "Ambarlı", "Cihangir", "Denizköşkler", "Firuzköy", "Gümüşpala", "Merkez", "Mustafa Kemalpaşa",
        "Tahtakale", "Üniversite", "Yeşilkent"
    ],
    "Bağcılar": [
        "15 Temmuz", "Bağlar", "Barbaros", "Çınar", "Demirkapı", "Fatih", "Fevzi Çakmak", "Göztepe", "Güneşli",
        "Hürriyet", "İnönü", "Kâzım Karabekir", "Kemalpaşa", "Kirazlı", "Mahmutbey", "Merkez", "Sancaktepe",
        "Yavuzselim", "Yenimahalle", "Yenigün", "Yıldıztepe", "Yüzyıl"
    ],
    "Bahçelievler": [
        "Bahçelievler", "Cumhuriyet", "Çobançeşme", "Fevzi Çakmak", "Hürriyet", "Kocasinan", "Merkez",
        "Siyavuşpaşa", "Soğanlı", "Şirinevler", "Yenibosna Merkez", "Zafer"
    ],
    "Bakırköy": [
        "Ataköy 1. Kısım", "Ataköy 2-5-6. Kısım", "Ataköy 3-4-11. Kısım", "Ataköy 7-8-9-10. Kısım", "Basınköy",
        "Cevizlik", "Kartaltepe", "Osmaniye", "Sakızağacı", "Şenlikköy", "Yenimahalle", "Yeşilköy",
        "Yeşilyurt", "Zeytinlik", "Zuhuratbaba"
    ],
    "Başakşehir": [
        "Altınşehir", "Bahçeşehir 1. Kısım", "Bahçeşehir 2. Kısım", "Başak", "Başakşehir", "Güvercintepe",
        "Kayabaşı", "Şahintepe", "Şamlar", "Ziya Gökalp"
    ],
    "Bayrampaşa": [
        "Altıntepsi", "Cevatpaşa", "İsmetpaşa", "Kartaltepe", "Kocatepe", "Muratpaşa", "Orta", "Terazidere",
        "Vatan", "Yenidoğan", "Yıldırım"
    ],
    "Beşiktaş": [
        "Abbasağa", "Akat", "Arnavutköy", "Balmumcu", "Bebek", "Cihannüma", "Dikilitaş", "Etiler", "Gayrettepe",
        "Konaklar", "Kuruçeşme", "Kültür", "Levazım", "Levent", "Mecidiye", "Muradiye", "Nisbetiye", "Ortaköy",
        "Sinanpaşa", "Türkali", "Ulus", "Vişnezade", "Yıldız"
    ],
    "Beykoz": [
        "Acarlar", "Akbaba", "Alibahadır", "Anadolufeneri", "Anadolu Hisarı", "Anadolu Kavağı", "Baklacı", "Bozhane",
        "Cumhuriyet", "Çamlıbahçe", "Çengeldere", "Çiftlik", "Çiğdem", "Çubuklu", "Dereseki", "Elmalı", "Fatih",
        "Göksu", "Göllü", "Görele", "Göztepe", "Gümüşsuyu", "İncirköy", "İshaklı", "Kanlıca", "Kavacık", "Kaynarca",
        "Kılıçlı", "Mahmutşevketpaşa", "Merkez", "Ortaçeşme", "Öğümce", "Örnekköy", "Paşabahçe", "Paşamandıra",
        "Polonezköy", "Poyrazköy", "Riva", "Rüzgarlıbahçe", "Soğuksu", "Tokatköy", "Yalıköy", "Yavuzselim",
        "Yenimahalle", "Zerzevatçı"
    ],
    "Beylikdüzü": [
        "Adnan Kahveci", "Barış", "Büyükşehir", "Cumhuriyet", "Dereağzı", "Gürpınar", "Kavaklı", "Marmara",
        "Sahil", "Yakuplu"
    ],
    "Beyoğlu": [
        "Arap Cami", "Asmalı Mescit", "Bedrettin", "Bereketzade", "Bostan", "Bülbül", "Camiikebir",
        "Cihangir", "Çatma Mescit", "Çukur", "Emekyemez", "Evliya Çelebi", "Fetihtepe", "Firuzağa",
        "Gümüşsuyu", "Hacıahmet", "Hacımimi", "Halıcıoğlu", "Hüseyinağa", "İstiklal", "Kadımehmet Efendi",
        "Kalyoncukulluk", "Kamerhatun", "Kaptanpaşa", "Katip Mustafa Çelebi", "Keçecipiri", "Kemankeş",
        "Karamustafapaşa", "Kılıçali Paşa", "Kocatepe", "Kulaksız", "Kuloğlu", "Küçük Piyale", "Müeyyetzade",
        "Ömeravni", "Örnektepe", "Piripaşa", "Piyalepaşa", "Pürtelaş Hasan Efendi", "Sururi Mehmet Efendi",
      "Sütlüce", "Şahkulu", "Şehit Muhtar", "Tomtom", "Yahya Kâhya", "Yenişehir"
    ],

    "Büyükçekmece": [
        "19 Mayıs", "Ahmediye", "Alkent 2000", "Atatürk", "Bahçelievler", "Celaliye", "Cumhuriyet",
        "Çakmaklı", "Dizdariye", "Ekinoba", "Fatih", "Güzelce", "Hürriyet", "Kamiloba", "Karaağaç",
        "Kumburgaz", "Mimaroba", "Mimarsinan", "Murat Çeşme", "Pınartepe", "Sinanoba", "Türkoba", "Ulus", "Yenimahalle"
    ],

    "Çatalca": [
        "Akalan", "Atatürk", "Aydınlar", "Bahşayiş", "Başak", "Belgrat", "Celepköy", "Çakıl", "Çanakça",
        "Çiftikköy", "Dağyenice", "Elbasan", "Fatih", "Ferhatpaşa", "Gökçeali", "Gümüşpınar", "Hallaçlı",
        "Hisarbeyli", "İhsaniye", "İnceğiz", "İzzettin", "Kabakça", "Kaleiçi", "Kalfa", "Karacaköy Merkez",
        "Karamandere", "Kestanelik", "Kızılcaali", "Muratbey Merkez", "Nakkaş", "Oklalı", "Ormanlı",
        "Ovayenice", "Örcünlü", "Örencik", "Subaşı", "Yalıköy", "Yaylacık", "Yazlık"
    ],
    "Çekmeköy": [
        "Alemdağ", "Aydınlar", "Cumhuriyet", "Çamlık", "Çatalmeşe", "Ekşioğlu",
        "Güngören", "Hamidiye", "Hüseyinli", "Kirazlıdere", "Koçullu", "Mehmet Akif",
        "Merkez", "Mimarsinan", "Nişantepe", "Ömerli", "Reşadiye", "Sırapınar",
        "Soğukpınar", "Sultançiftliği", "Taşdelen"
    ],
    "Esenler": [
        "15 Temmuz", "Atışalanı", "Birlik", "Çiftehavuzlar", "Davutpaşa", "Fatih",
        "Fevzi Çakmak", "Kazım Karabekir", "Kemer", "Menderes", "Mimar Sinan",
        "Namık Kemal", "Nenehatun", "Oruçreis", "Tuna", "Turgutreis", "Yavuz Selim"
    ],
    "Esenyurt": [
        "Akçaburgaz", "Akevler", "Akşemseddin", "Ardıçlı", "Aşık Veysel", "Atatürk",
        "Bağlarçeşme", "Balık Yolu", "Barbaros Hayrettin Paşa", "Battalgazi",
        "Cumhuriyet", "Çınar", "Esenkent", "Fatih", "Gökevler", "Güzelyurt",
        "Hürriyet", "İncirtepe", "İnönü", "İstiklal", "Koza", "Mehmet Akif Ersoy",
        "Mehterçeşme", "Mevlana", "Namık Kemal", "Necip Fazıl Kısakürek", "Orhan Gazi",
        "Osmangazi", "Örnek", "Pınar", "Piri Reis", "Saadetdere", "Selahaddin Eyyubi",
        "Sultaniye", "Süleymaniye", "Şehitler", "Talatpaşa", "Turgut Özal", "Üçevler",
        "Yenikent", "Yeşilkent", "Yunus Emre", "Zafer"
    ],
    "Eyüpsultan": [
    "5. Levent", "Ağaçlı", "Akpınar", "Akşemsettin", "Alibeyköy", "Çırçır",
        "Çiftalan", "Defterdar", "Düğmeciler", "Emniyettepe", "Esentepe", "Göktürk",
        "Güzeltepe", "Işıklar", "İhsaniye", "İslambey", "Karadolap", "Merkez",
        "Mimar Sinan", "Mithatpaşa", "Nişanca", "Odayeri", "Pirinççi", "Rami Cuma",
        "Rami Yeni", "Silahtarağa", "Sakarya", "Topçular", "Yeşilpınar"
    ],
    "Fatih": [
        "Aksaray", "Akşemsettin", "Alemdar", "Ali Kuşçu", "Atikali", "Ayvansaray",
        "Balabanağa", "Balat", "Beyazıt", "Binbirdirek", "Cankurtaran", "Cerrahpaşa",
        "Cibali", "Demirtaş", "Derviş Ali", "Eminsinan", "Hacı Kadın", "Haseki Sultan",
        "Hırka-i Şerif", "Hobyar", "Hoca Gıyasettin", "Hocapaşa", "İskenderpaşa",
        "Kalenderhane", "Karagümrük", "Katip Kasım", "Kemalpaşa", "Küçük Ayasofya",
        "Koca Mustafapaşa", "Mercan", "Mesihpaşa", "Mevlanakapı", "Mimar Hayrettin",
        "Mimar Kemalettin", "Molla Fenari", "Molla Gürani", "Molla Hüsrev",
        "Muhsine Hatun", "Nişanca", "Rüstempaşa", "Saraçishak", "Sarıdemir",
        "Seyyid Ömer", "Silivrikapı", "Sultan Ahmet", "Sururi", "Süleymaniye",
        "Sümbül Efendi", "Şehremini", "Şehsuvar Bey", "Tahtakale", "Taya Hatun",
        "Topkapı", "Yavuz Sinan", "Yavuz Sultan Selim", "Yedikule", "Zeyrek"
    ],
    "Gaziosmanpaşa": [
        "Bağlarbaşı", "Barbaros Hayrettin Paşa", "Fevzi Çakmak", "Hürriyet",
        "Karadeniz", "Karayolları", "Karlıtepe", "Kâzım Karabekir", "Merkez",
        "Mevlana", "Pazariçi", "Sarıgöl", "Şemsipaşa", "Yenidoğan", "Yenimahalle", "Yıldıztabya"
    ],
    "Güngören": [
        "Abdurrahman Nafiz Gürman", "Akıncılar", "Gençosman", "Güneştepe", "Güven", "Haznedar",
        "Mareşal Çakmak", "Mehmet Nesih Özmen", "Merkez", "Sanayi", "Tozkoparan"
    ],
    "Kadıköy": [
        "Acıbadem", "Bostancı", "Caddebostan", "Caferağa", "Dumlupınar", "Eğitim", "Erenköy",
        "Fenerbahçe", "Feneryolu", "Fikirtepe", "Göztepe", "Hasanpaşa", "Koşuyolu", "Kozyatağı",
        "Merdivenköy", "19 Mayıs", "Osmanağa", "Rasimpaşa", "Sahrayıcedid", "Suadiye", "Zühtüpaşa"
    ],
    "Kağıthane": [
        "Çağlayan", "Çeliktepe", "Emniyet Evleri", "Gültepe", "Gürsel", "Hamidiye", "Harmantepe",
        "Hürriyet", "Mehmet Akif Ersoy", "Merkez", "Nurtepe", "Ortabayır", "Seyrantepe", "Sultan Selim",
        "Şirintepe", "Talatpaşa", "Telsizler", "Yahya Kemal", "Yeşilce"
    ],
    "Kartal": [
        "Atalar", "Cevizli", "Cumhuriyet", "Çavuşoğlu", "Esentepe", "Gümüşpınar", "Hürriyet",
        "Karlıktepe", "Kordonboyu", "Orhantepe", "Orta", "Petrol İş", "Soğanlık Yeni", "Topselvi",
        "Uğur Mumcu", "Yakacık Çarşı", "Yakacık Yeni", "Yalı", "Yukarı", "Yunus"
    ],
    "Küçükçekmece": [
        "Atakent", "Atatürk", "Beşyol", "Cennet", "Cumhuriyet", "Fatih", "Fevzi Çakmak", "Gültepe",
        "Halkalı Merkez", "İnönü", "İstasyon", "Kanarya", "Kartaltepe", "Kemalpaşa", "Mehmet Akif",
        "Söğütlüçeşme", "Sultanmurat", "Tevfikbey", "Yarımburgaz", "Yenimahalle", "Yeşilova"
    ],
    "Maltepe": [
        "Altayçeşme", "Altıntepe", "Aydınevler", "Bağlarbaşı", "Başıbüyük", "Büyükbakkalköy", "Cevizli",
        "Çınar", "Esenkent", "Feyzullah", "Fındıklı", "Girne", "Gülensu", "Gülsuyu", "İdealtepe",
        "Küçükyalı", "Merkez", "Yalı", "Zümrütevler"
    ],
    "Pendik": [
        "Ahmet Yesevi", "Bahçelievler", "Ballıca", "Batı", "Çamçeşme", "Çamlık", "Çınardere", "Doğu",
        "Dumlupınar", "Emirli", "Ertuğrulgazi", "Esenler", "Esenyalı", "Fatih", "Fevzi Çakmak",
        "Göçbeyli", "Güllübağlar", "Güzelyalı", "Harmandere", "Kavakpınar", "Kaynarca", "Kurna",
        "Kurtdoğmuş", "Kurtköy", "Orhangazi", "Orta", "Ramazanoğlu", "Sanayi", "Sapanbağları",
        "Sülüntepe", "Şeyhli", "Velibaba", "Yayalar", "Yeni", "Yenişehir", "Yeşilbağlar"
    ],
    "Sancaktepe": [
        "Abdurrahmangazi", "Akpınar", "Atatürk", "Emek", "Eyüp Sultan", "Fatih", "Hilal", "İnönü", "Kemal Türkler",
        "Meclis", "Merve", "Mevlana", "Osmangazi", "Paşaköy", "Safa", "Sarıgazi", "Veysel Karani", "Yenidoğan", "Yunus Emre"
    ],
    "Sarıyer": [
        "Ayazağa", "Baltalimanı", "Bahçeköy (Kemer Merkez Yeni)", "Büyükdere", "Cumhuriyet", "Çamlıtepe (Derbent)", "Çayırbaşı",
        "Darüşşafaka", "Demirciköy", "Emirgan", "Fatih Sultan Mehmet", "Ferahevler", "Garipçe", "Gümüşdere", "Huzur", "İstinye",
        "Kâzım Karabekir Paşa", "Kısırkaya", "Kilyos", "Kireçburnu", "Kocataş", "Maden", "Maslak", "Pınar", "Poligon", "PTT Evleri",
        "Reşitpaşa", "Rumelifeneri", "Rumelihisarı", "Rumelikavağı", "Sarıyer", "Tarabya", "Uskumruköy", "Yeniköy", "Yeni", "Zekeriyaköy"
    ],
    "Silivri": [
        "Akören", "Alibey", "Alipaşa", "Bekirli", "Beyciler", "Büyük Çavuşlu", "Büyük Kılıçlı", "Büyük Sinekli",
        "Cumhuriyet", "Çanta Balaban", "Çanta Sancaktepe", "Çayırdere", "Çeltik", "Danamandıra", "Değirmenköy Fevzipaşa",
        "Değirmenköy İsmetpaşa", "Fatih", "Fener", "Gazitepe", "Gümüşyaka", "Kadıköy", "Kavaklı Hürriyet", "Kavaklı İstiklal",
        "Kurfallı", "Küçük Kılıçlı", "Küçük Sinekli", "Mimar Sinan", "Ortaköy", "Piri Mehmet Paşa", "Sayalar", "Selimpaşa",
        "Semizkumlar", "Seymen", "Yeni", "Yolçatı"
    ],
    "Sultanbeyli": [
        "Abdurrahmangazi", "Adil", "Ahmet Yesevi", "Akşemsettin", "Battalgazi", "Fatih", "Hamidiye", "Hasanpaşa",
        "Mimar Sinan", "Mecidiye", "Mehmet Akif", "Necip Fazıl", "Orhangazi", "Turgut Reis", "Yavuz Selim"
    ],
    "Sultangazi": [
        "50. Yıl", "75. Yıl", "Cebeci", "Cumhuriyet", "Esentepe", "Eski Habipler", "Gazi", "Habibler",
        "İsmetpaşa", "Malkoçoğlu", "Sultançiftliği", "Uğur Mumcu", "Yayla", "Yunus Emre", "Zübeyde Hanım"
    ],
    "Şile": [
        "Balibey", "Çavuş", "Hacıkasım", "Kumbaba", "Ağaçdere", "Ağva Merkez", "Ahmetli", "Akçakese", "Alacalı", "Avcıkoru",
        "Bıçkıdere", "Bozgoca", "Bucaklı", "Çataklı", "Çayırbaşı", "Çelebi", "Çengilli", "Darlık", "Değirmençayırı", "Doğancılı",
        "Erenler", "Esenceli", "Geredeli", "Göçe", "Gökmaşlı", "Göksu", "Hasanlı", "Hacıllı", "İmrendere", "İmrenli", "İsaköy",
        "Kabakoz", "Kadıköy", "Kalem", "Karabeyli", "Karacaköy", "Karamandere", "Karakiraz", "Kervansaray", "Kızılca", "Korucu",
        "Kurna", "Kurfallı", "Kömürlük", "Meşrutiyet", "Oruçoğlu", "Osmanköy", "Ovacık", "Satmazlı", "Sahilköy", "Soğullu",
        "Sortullu", "Sofular", "Şuayipli", "Teke", "Ulupelit", "Üvezli", "Yazımanayır", "Yaka", "Yaylalı", "Yeniköy", "Yeşilvadi"
    ],
    "Şişli": [
        "19 Mayıs", "Bozkurt", "Cumhuriyet", "Duatepe", "Ergenekon", "Esentepe", "Eskişehir", "Feriköy", "Fulya",
        "Gülbahar", "Halaskargazi", "Halide Edip Adıvar", "Halil Rıfat Paşa", "Harbiye", "İnönü", "İzzetpaşa", "Kaptanpaşa",
        "Kuştepe", "Mahmut Şevket Paşa", "Mecidiyeköy", "Merkez", "Meşrutiyet", "Paşa", "Teşvikiye", "Yayla"
    ],
    "Tuzla": [
        "Akfırat","Anadolu", "Aydınlı", "Aydıntepe", "Cami", "Evliya Çelebi", "Fatih", "İçmeler", "İstasyon",
        "Mescit", "Mimar Sinan", "Orhanlı", "Orta", "Postane", "Şifa", "Tepeören", "Yayla"
    ],
    "Ümraniye": [
        "Adem Yavuz", "Altınşehir", "Armağanevler", "Aşağıdudullu", "Atakent", "Atatürk",
        "Cemil Meriç", "Çakmak", "Çamlık", "Dumlupınar", "Elmalıkent",
        "Esenevler", "Esenkent", "Esenşehir", "Fatih Sultan Mehmet", "Finanskent",
        "Hekimbaşı", "Huzur", "Ihlamurkuyu", "İnkılap", "İstiklal", "Kâzım Karabekir",
        "Madenler", "Mehmet Akif", "Namık Kemal", "Necip Fazıl", "Parseller",
        "Site", "Şerifali", "Tantavi", "Tatlısu", "Tepeüstü", "Topağacı",
        "Yamanevler", "Yukarıdudullu"
    ],
    "Üsküdar": [
        "Acıbadem", "Ahmediye", "Altunizade", "Aziz Mahmut Hüdayi", "Bahçelievler", "Barbaros",
        "Beylerbeyi", "Bulgurlu", "Burhaniye", "Cumhuriyet", "Çengelköy", "Ferah",
        "Güzeltepe", "İcadiye", "Kandilli", "Kirazlıtepe", "Kısıklı", "Kuleli", "Kuzguncuk",
        "Küçük Çamlıca", "Küçüksu", "Küplüce", "Mehmet Akif Ersoy", "Mimar Sinan",
        "Muratreis", "Salacak", "Selami Ali", "Selimiye", "Sultantepe", "Ünalan",
        "Valide-i Atik", "Yavuztürk", "Zeynep Kamil"
    ],
    "Zeytinburnu": [
        "Beştelsiz", "Çırpıcı", "Gökalp", "Kazlıçeşme", "Maltepe", "Merkezefendi",
        "Nuripaşa", "Seyitnizam", "Sümer", "Telsiz", "Veliefendi", "Yenidoğan", "Yeşiltepe"
    ]
  };
 
const ilceSelect = document.getElementById("ilce");
const mahalleSelect = document.getElementById("mahalle");

for (let ilce in ilceMahalle) {
  const opt = document.createElement("option");
  opt.value = ilce;
  opt.text = ilce;
  ilceSelect.appendChild(opt);
}

ilceSelect.addEventListener("change", function () {
  const secilenIlce = this.value;
  mahalleSelect.innerHTML = "";

  if (secilenIlce && ilceMahalle[secilenIlce]) {
    ilceMahalle[secilenIlce].forEach(mahalle => {
      const opt = document.createElement("option");
      opt.value = mahalle;
      opt.text = mahalle;
      mahalleSelect.appendChild(opt);
    });
  } else {
    const opt = document.createElement("option");
    opt.text = "Önce ilçe seçin";
    mahalleSelect.appendChild(opt);
  }
});

let kazaGrafikChart = null;

async function tahminEt() {
  const metin = document.getElementById("ihbar").value;
  const ilce = ilceSelect.value;
  const mahalle = mahalleSelect.value;
  const acilNo = document.getElementById("acil").value;

  const res = await fetch("/tahmin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      ihbar: metin,
      ilce: ilce,
      mahalle: mahalle,
      acil: acilNo
    })
  });

  const veri = await res.json();

  //  Eğer tahmin ve riskYuzdesi varsa ekrana yazdır
  if (veri.tahmin && veri.riskYuzdesi !== undefined) {
    document.getElementById("olay_sonuc").innerText = `${veri.tahmin} (${veri.riskYuzdesi}% güven)`;
  } else {
    document.getElementById("olay_sonuc").innerText = veri.tahmin || "Tahmin yapılamadı";
  }
}

let sebepOranChart = null;

function mahalleSebepOranGoster() {
  const mahalle = document.getElementById("mahalle").value;

  if (!mahalle || mahalle === "Önce ilçe seçin") {
    alert("Lütfen önce bir mahalle seçin.");
    return;
  }

  // Sadece mahalle adını küçük harfe çevirip sadeleştirerek 
  const sade_mahalle = mahalle.toLowerCase().replace(" mahallesi", "").trim();

  fetch("/mahalle_sebep_oranlari", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mahalle: sade_mahalle })  // sadeleştirilmiş mahalle gönderiliyor
  })
    .then(res => res.json())
    .then(data => {
      if (data.hata) {
        alert(data.hata);
        return;
      }

      const labels = Object.keys(data);
      const values = Object.values(data).map(x => x * 100); // oranları yüzdeye çevir

      const ctx = document.getElementById("sebepOranGrafik").getContext("2d");

      if (sebepOranChart) sebepOranChart.destroy();

      sebepOranChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: "Olay Türü Oranı (%)",
            data: values,
            backgroundColor: "#9b59b6"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function (value) {
                  return value + "%";
                }
              }
            }
          }
        }
      });
    });
}



async function kazaTahminEt() {
  const ilce = ilceSelect.value;
  const res = await fetch("/kaza_tahmin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ilce: ilce })
  });

  const veri = await res.json();
  const mahalleler = Object.keys(veri.mahalle_kazalari);
  const sayilar = Object.values(veri.mahalle_kazalari);

  const ctx = document.getElementById("kazaGrafik").getContext("2d");
  if (kazaGrafikChart) kazaGrafikChart.destroy();
  kazaGrafikChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: mahalleler,
      datasets: [{
        label: 'Mahalle Bazlı Kaza Sayısı',
        data: sayilar,
        backgroundColor: "#3498db"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { ticks: { maxRotation: 90, minRotation: 45 } }
      }
    }
  });
}

async function ilceKazaDagilimi() {
  const ilce = document.getElementById("ilce").value;
  const mahalle = document.getElementById("mahalle").value;

  const res = await fetch("/ilce_kaza_dagilimi", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ilce: ilce, mahalle: mahalle })
  });

  const veri = await res.json();
  if (veri.hata) {
    alert("Hata: " + veri.hata);
    return;
  }

  if (kazaGrafikChart) kazaGrafikChart.destroy();
  const ctx = document.getElementById("kazaGrafik").getContext("2d");
  kazaGrafikChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: veri.mahalleler,
      datasets: [{
        label: 'Mahalle Bazlı Kaza Sayısı',
        data: veri.kazalar,
        backgroundColor: veri.mahalleler.map(m => m === veri.secilen ? '#e74c3c' : '#3498db')
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });
}
